<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¥½æ¼æ—¥ï½œæ·±æµ·è—ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { 
      font-family: 'Noto Sans TC', sans-serif; 
      background: linear-gradient(135deg, #041c32, #04293a, #064663);
      background-attachment: fixed;
      color: #e8f6ff;
      min-height: 100vh;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
    }
    .nav-btn.active { 
      background: linear-gradient(135deg, #0077b6, #00b4d8);
      color: white; 
      box-shadow: 0 4px 15px rgba(0, 180, 216, 0.4);
    }
    .nav-btn { color: #a9d6e5; transition: all 0.3s ease; }
    
    .modal-active { opacity: 1; pointer-events: auto; }
    
    table th { background: rgba(0, 119, 182, 0.3) !important; color: #90e0ef; text-transform: uppercase; font-size: 0.85rem;}
    table td { border-bottom: 1px solid rgba(255,255,255,0.05); }
    table tr:hover { background-color: rgba(255,255,255,0.05); }
    
    input { 
      background: rgba(0, 0, 0, 0.2) !important; 
      border: 1px solid rgba(255, 255, 255, 0.2) !important; 
      color: white !important; 
      border-radius: 0.5rem;
    }
    input:focus { border-color: #00b4d8 !important; outline: none; }
  </style>
</head>
<body class="bg-gray-900">

<script>
  // â˜…â˜…â˜… è«‹ç¢ºèªæ­¤è™• GAS ç¶²å€å·²éƒ¨ç½²ç‚ºæœ€æ–°ç‰ˆæœ¬ â˜…â˜…â˜…
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyXw6L_72xAE08U6-hRJm0S52cNCT4NliKGlAmRn5Ya361xfDGhG8d59jZmXqFNsNBt/exec";
</script>

<!-- ç™»å…¥ç•«é¢ -->
<div id="login-view" class="fixed inset-0 bg-[#041c32] flex items-center justify-center z-[100] p-4">
  <div class="glass-card w-full max-w-md p-8 text-center shadow-2xl">
    <div class="text-4xl mb-2">ğŸŒŠ</div>
    <div class="text-3xl font-black text-[#00b4d8] mb-6">å¥½æ¼æ—¥ç®¡ç†ç³»çµ±</div>
    <input id="login-pwd" type="password" class="w-full px-4 py-4 mb-4 text-center text-2xl tracking-widest" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" />
    <button onclick="login()" class="w-full bg-gradient-to-r from-[#0077b6] to-[#00b4d8] text-white font-bold py-4 rounded-2xl text-xl hover:opacity-90 transition-all shadow-lg shadow-cyan-500/30">ç™»å…¥ç³»çµ±</button>
    <div id="login-msg" class="text-center text-red-400 mt-4 font-bold"></div>
  </div>
</div>

<!-- å¾Œå°ä¸»ç•«é¢ -->
<div id="admin-view" class="hidden">
  <header class="bg-black/30 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between py-4 gap-4">
      <h1 class="text-2xl font-black text-[#caf0f8] tracking-tighter">ğŸŒŠ å¥½æ¼æ—¥ï½œå°ˆæ¥­å¾Œå°</h1>
      <nav class="flex bg-black/20 p-1 rounded-xl">
        <button onclick="switchTab('orders')" id="tab-orders" class="nav-btn active px-4 py-2 rounded-lg font-bold text-sm">è¨‚å–®ç®¡ç†</button>
        <button onclick="switchTab('history')" id="tab-history" class="nav-btn px-4 py-2 rounded-lg font-bold text-sm">è¨‚å–®ç¸½è¡¨</button>
        <button onclick="switchTab('menu')" id="tab-menu" class="nav-btn px-4 py-2 rounded-lg font-bold text-sm">èœå–®ç®¡ç†</button>
      </nav>
      <button onclick="location.reload()" class="bg-white/10 hover:bg-red-500/20 px-4 py-2 rounded-lg text-sm text-gray-300 transition">ç™»å‡º</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <!-- 1. è¨‚å–®ç®¡ç† -->
    <section id="view-orders" class="tab-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-[#90e0ef]"><i class="fas fa-fish mr-2"></i>å³æ™‚è¨‚å–®</h2>
        <button onclick="loadData()" class="bg-[#0077b6] px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-[#0096c7] text-white">åˆ·æ–°æ•¸æ“š</button>
      </div>
      <div id="tables-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- 2. è¨‚å–®ç¸½è¡¨ -->
    <section id="view-history" class="tab-content hidden">
      <div class="glass-card p-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
          <h2 class="text-xl font-bold text-[#90e0ef]">æ‰€æœ‰ç´€éŒ„ (æœ€æ–°çš„åœ¨å‰)</h2>
          <button onclick="triggerDeleteAllOrders()" class="bg-red-500/20 text-red-300 px-4 py-2 rounded-xl font-bold border border-red-500/30 hover:bg-red-600 hover:text-white transition-all">
            <i class="fas fa-trash-alt mr-2"></i>æ¸…ç©ºè©¦ç®—è¡¨è³‡æ–™
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr>
                <th class="px-4 py-4 rounded-tl-lg">æ™‚é–“</th>
                <th class="px-4 py-4">æ¡Œè™Ÿ</th>
                <th class="px-4 py-4">å“é …</th>
                <th class="px-4 py-4">é‡‘é¡</th>
                <th class="px-4 py-4">ç‹€æ…‹</th>
                <th class="px-4 py-4 rounded-tr-lg text-center">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="history-tbody" class="text-sm"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 3. èœå–®ç®¡ç† -->
    <section id="view-menu" class="tab-content hidden">
      <div class="glass-card p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-[#90e0ef]">èœå–®å“é …è¨­å®š</h2>
          <button onclick="openMenuModal('add')" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:bg-emerald-500 transition-all btn-action">
            <i class="fas fa-plus mr-2"></i>æ–°å¢å“é …
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr>
                <th class="px-4 py-4 rounded-tl-lg">åˆ†é¡</th>
                <th class="px-4 py-4">åç¨±</th>
                <th class="px-4 py-4">æè¿°</th>
                <th class="px-4 py-4">åƒ¹æ ¼</th>
                <th class="px-4 py-4 text-center rounded-tr-lg">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="admin-menu-tbody" class="text-sm text-gray-200"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- é©—è­‰å½ˆçª— -->
<div id="modal-auth" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] opacity-0 pointer-events-none transition-all backdrop-blur-sm">
  <div class="glass-card p-8 max-w-sm w-full mx-4 border-cyan-500/30 shadow-2xl">
    <h3 id="auth-title" class="text-xl font-black mb-2 text-cyan-400">æ¬Šé™ç¢ºèª</h3>
    <p id="auth-desc" class="text-gray-400 mb-6 text-sm">æ­¤æ“ä½œéœ€è¦é©—è­‰ï¼Œè«‹è¼¸å…¥å¯†ç¢¼</p>
    <input id="input-auth-pwd" type="password" class="w-full px-4 py-3 mb-4 text-center text-xl tracking-widest" placeholder="é©—è­‰ç¢¼" />
    <div class="flex gap-2">
      <button onclick="closeModal('modal-auth')" class="flex-1 bg-white/10 py-3 rounded-xl font-bold hover:bg-white/20">å–æ¶ˆ</button>
      <button id="btn-auth-confirm" class="flex-1 bg-gradient-to-r from-red-600 to-red-500 text-white py-3 rounded-xl font-bold shadow-lg">ç¢ºèª</button>
    </div>
  </div>
</div>

<!-- èœå–®ç·¨è¼¯/æ–°å¢å½ˆçª— -->
<div id="modal-menu-edit" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[110] opacity-0 pointer-events-none transition-all backdrop-blur-sm">
  <div class="glass-card p-8 max-w-md w-full mx-4 shadow-2xl border-cyan-500/30">
    <h3 id="menu-modal-title" class="text-xl font-black mb-6 text-cyan-400">ç·¨è¼¯å“é …</h3>
    <input type="hidden" id="menu-row-id" />
    <div class="space-y-4">
      <div><label class="text-xs font-bold text-gray-400 mb-1 block">åˆ†é¡</label><input id="menu-cat" type="text" class="w-full p-2" /></div>
      <div><label class="text-xs font-bold text-gray-400 mb-1 block">åç¨±</label><input id="menu-name" type="text" class="w-full p-2" /></div>
      <div><label class="text-xs font-bold text-gray-400 mb-1 block">æè¿°</label><input id="menu-desc" type="text" class="w-full p-2" /></div>
      <div><label class="text-xs font-bold text-gray-400 mb-1 block">å–®åƒ¹</label><input id="menu-price" type="number" class="w-full p-2" /></div>
    </div>
    <div class="flex gap-2 mt-8">
      <button onclick="closeModal('modal-menu-edit')" class="flex-1 bg-white/10 py-3 rounded-xl font-bold hover:bg-white/20">å–æ¶ˆ</button>
      <button onclick="triggerMenuSave()" class="flex-1 bg-gradient-to-r from-[#0077b6] to-[#00b4d8] text-white py-3 rounded-xl font-bold shadow-lg">ä¸‹ä¸€æ­¥ (é©—è­‰)</button>
    </div>
  </div>
</div>

<script>
  let SESSION_TOKEN = "";
  let menuData = [];
  let tableButtonState = {};

  async function api(payload){
    if(SESSION_TOKEN && !payload.password) payload.token = SESSION_TOKEN;
    try {
      const res = await fetch(GAS_API_URL, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return await res.json();
    } catch (e) {
      return { ok: false, message: "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯" };
    }
  }

  async function login(){
    const pwd = document.getElementById("login-pwd").value.trim();
    const data = await api({ action:"adminLogin", password: pwd });
    if(data && data.ok){
      SESSION_TOKEN = pwd;
      document.getElementById("login-view").classList.add("hidden");
      document.getElementById("admin-view").classList.remove("hidden");
      loadData();
    } else {
      document.getElementById("login-msg").innerText = "å¯†ç¢¼éŒ¯èª¤";
    }
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById('view-' + tabId).classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    
    if(tabId === 'history') loadHistory();
    else if(tabId === 'menu') loadAdminMenu();
    else if(tabId === 'orders') loadData();
  }

  // ================= é©—è­‰æ ¸å¿ƒ (åƒè€ƒä¸Šå‚³çš„ç¨‹å¼ç¢¼é‚è¼¯) =================
  // é–‹å•Ÿé©—è­‰è¦–çª—ï¼Œä¸¦ç¶å®šæœ¬æ¬¡çš„ API å‘¼å«
  function openAuthModal(title, callback) {
    const modal = document.getElementById('modal-auth');
    const input = document.getElementById('input-auth-pwd');
    const confirmBtn = document.getElementById('btn-auth-confirm');
    
    document.getElementById('auth-title').innerText = title;
    input.value = "";
    modal.classList.add('modal-active');
    input.focus();

    // ç›´æ¥ç¶å®šæœ¬æ¬¡çš„ onclick è¡Œç‚º (é–‰åŒ…ç‰¹æ€§)
    confirmBtn.onclick = async () => {
      const pwd = input.value.trim();
      if(!pwd && !SESSION_TOKEN) return alert("è«‹è¼¸å…¥å¯†ç¢¼");
      
      confirmBtn.disabled = true; 
      confirmBtn.innerText = "è™•ç†ä¸­...";
      
      // åŸ·è¡Œå›èª¿ï¼Œå‚³å…¥å¯†ç¢¼
      await callback(pwd);
      
      confirmBtn.disabled = false; 
      confirmBtn.innerText = "ç¢ºèª";
    };
  }
  
  function closeModal(id) { 
    document.getElementById(id).classList.remove('modal-active'); 
  }

  // ================= èœå–®ç®¡ç† =================
  async function loadAdminMenu() {
    const tbody = document.getElementById('admin-menu-tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-cyan-200">èœå–®è¼‰å…¥ä¸­...</td></tr>';
    try {
      const resp = await fetch(`${GAS_API_URL}?action=getMenu`);
      const res = await resp.json();
      if(res.ok) {
        menuData = res.data;
        tbody.innerHTML = res.data.map(m => `
          <tr class="hover:bg-white/5 border-b border-white/5 transition">
            <td class="px-4 py-4 font-bold text-cyan-400">${m.category}</td>
            <td class="px-4 py-4 font-black text-white">${m.name}</td>
            <td class="px-4 py-4 text-gray-400 text-xs">${m.desc}</td>
            <td class="px-4 py-4 font-bold text-emerald-300">$${m.price}</td>
            <td class="px-4 py-4 text-center space-x-3">
              <button onclick="openMenuModal('edit', ${m.row})" class="text-blue-400 hover:text-white transition"><i class="fas fa-edit"></i></button>
              <button onclick="triggerMenuDelete(${m.row})" class="text-gray-500 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`).join('');
      }
    } catch (e) { tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-red-400">è¼‰å…¥å¤±æ•—</td></tr>'; }
  }

  function openMenuModal(mode, rowId) {
    const modal = document.getElementById('modal-menu-edit');
    modal.classList.add('modal-active');
    if(mode === 'add') {
      document.getElementById('menu-row-id').value = "";
      ['cat','name','desc','price'].forEach(k => document.getElementById('menu-'+k).value = "");
      document.getElementById('menu-modal-title').innerText = "æ–°å¢å“é …";
    } else {
      const item = menuData.find(m => m.row === rowId);
      document.getElementById('menu-row-id').value = rowId;
      document.getElementById('menu-cat').value = item.category;
      document.getElementById('menu-name').value = item.name;
      document.getElementById('menu-desc').value = item.desc;
      document.getElementById('menu-price').value = item.price;
      document.getElementById('menu-modal-title').innerText = "ç·¨è¼¯å“é …";
    }
  }

  // è§¸ç™¼å„²å­˜ (æ–°å¢æˆ–ç·¨è¼¯)
  function triggerMenuSave() {
    const rowId = document.getElementById('menu-row-id').value;
    const payload = {
      category: document.getElementById('menu-cat').value,
      name: document.getElementById('menu-name').value,
      desc: document.getElementById('menu-desc').value,
      price: document.getElementById('menu-price').value
    };

    // é©—è­‰è¼¸å…¥
    if(!payload.name || !payload.price) return alert("è«‹å¡«å¯«åç¨±èˆ‡åƒ¹æ ¼");

    // å‘¼å«é©—è­‰è¦–çª—
    openAuthModal("ç¢ºèªå„²å­˜èœå–®", async (pwd) => {
      // åˆ¤æ–·å‹•ä½œé¡å‹ (æœ‰ rowId è¡¨ç¤ºç·¨è¼¯ï¼Œå¦å‰‡ç‚ºæ–°å¢)
      const action = rowId ? "editMenuItem" : "addMenuItem";
      const finalPayload = { ...payload, row: rowId, action: action, password: pwd };
      
      const res = await api(finalPayload);
      
      if(res.ok) {
        alert("å„²å­˜æˆåŠŸ");
        closeModal('modal-auth');
        closeModal('modal-menu-edit');
        loadAdminMenu();
      } else {
        alert("å¤±æ•—: " + res.message);
      }
    });
  }

  // è§¸ç™¼åˆªé™¤èœå–®
  function triggerMenuDelete(rowId) {
    openAuthModal("ç¢ºèªåˆªé™¤å“é …", async (pwd) => {
      const res = await api({ action: "deleteMenuItem", row: rowId, password: pwd });
      if(res.ok) {
        alert("å·²åˆªé™¤");
        closeModal('modal-auth');
        loadAdminMenu();
      } else {
        alert("åˆªé™¤å¤±æ•—: " + res.message);
      }
    });
  }

  // ================= è¨‚å–®ç¸½è¡¨ç®¡ç† =================
  async function loadHistory() {
    const tbody = document.getElementById('history-tbody');
    tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-cyan-200">è®€å–ä¸­...</td></tr>';
    const res = await api({ action: "getOrderHistory" });
    if(res.ok) {
      if(res.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-500">å°šç„¡æ­·å²è³‡æ–™</td></tr>';
        return;
      }
      tbody.innerHTML = res.data.map(r => `
        <tr class="hover:bg-white/5 border-b border-white/5 transition-colors">
          <td class="px-4 py-4 text-xs text-gray-400">${new Date(r.time).toLocaleString()}</td>
          <td class="px-4 py-4 font-bold text-white">${r.table}</td>
          <td class="px-4 py-4 text-gray-200">${r.name} x ${r.qty}</td>
          <td class="px-4 py-4 font-bold text-cyan-400">$${r.subtotal}</td>
          <td class="px-4 py-4 text-xs"><span class="px-2 py-1 rounded ${r.status==='completed'?'bg-gray-500/20 text-gray-400':'bg-emerald-500/20 text-emerald-400'}">${r.status}</span></td>
          <td class="px-4 py-4 text-center">
            <button onclick="triggerDeleteOrder(${r.row})" class="text-gray-500 hover:text-red-400 transition"><i class="fas fa-trash-alt"></i></button>
          </td>
        </tr>`).join('');
    }
  }

  // è§¸ç™¼åˆªé™¤å–®ç­†è¨‚å–®
  function triggerDeleteOrder(rowId) {
    openAuthModal("ç¢ºèªåˆªé™¤æ­¤ç­†è¨‚å–®", async (pwd) => {
      // æ³¨æ„ï¼šæ ¹æ“šå¾Œç«¯é‚è¼¯ï¼Œåˆªé™¤è¨‚å–®éœ€æŒ‡å®š targetSheet="order" ä¸” action="deleteMenuItem"
      const res = await api({ 
        action: "deleteMenuItem", 
        row: rowId, 
        targetSheet: "order", 
        password: pwd 
      });
      
      if(res.ok) {
        alert("è¨‚å–®å·²åˆªé™¤");
        closeModal('modal-auth');
        loadHistory();
      } else {
        alert("åˆªé™¤å¤±æ•—: " + res.message);
      }
    });
  }

  // è§¸ç™¼æ¸…ç©ºæ‰€æœ‰è¨‚å–®
  function triggerDeleteAllOrders() {
    if(!confirm("è­¦å‘Šï¼šæ­¤å‹•ä½œå°‡æ¸…ç©ºæ‰€æœ‰è¨‚å–®ç´€éŒ„ä¸”ç„¡æ³•å¾©åŸï¼")) return;
    
    openAuthModal("æœ€å¾Œç¢ºèªï¼šæ¸…ç©ºè³‡æ–™åº«", async (pwd) => {
      const res = await api({ action: "deleteAllOrders", password: pwd });
      if(res.ok) {
        alert("è³‡æ–™åº«å·²æ¸…ç©º");
        closeModal('modal-auth');
        loadHistory();
      } else {
        alert("åŸ·è¡Œå¤±æ•—: " + res.message);
      }
    });
  }

  // ================= å³æ™‚è¨‚å–®é‚è¼¯ (ä¸è®Š) =================
  async function loadData() {
    const root = document.getElementById("tables-grid");
    root.innerHTML = '<div class="col-span-full text-center p-10 text-gray-400">è¼‰å…¥ä¸­...</div>';
    const res = await api({ action: "getPendingOrdersMerged" });
    if(res.ok) {
      if(res.data.length === 0) {
        root.innerHTML = '<div class="col-span-full text-center p-10 text-gray-500">ç›®å‰ç„¡å¾…è™•ç†è¨‚å–®</div>';
        return;
      }
      root.innerHTML = res.data.map(t => {
        if (!tableButtonState[t.table]) tableButtonState[t.table] = (t.status === "served") ? "completed" : "served";
        const isWait = tableButtonState[t.table] === "completed";
        return `
        <div class="glass-card p-6">
          <div class="flex justify-between items-start mb-4">
             <div class="text-2xl font-black text-white">æ¡Œè™Ÿ ${t.table}</div>
             <button onclick="handleTableStatus('${t.table}')" class="px-4 py-2 rounded-lg font-bold text-white shadow-lg transition ${isWait ? 'bg-indigo-600 hover:bg-indigo-500' : 'bg-emerald-600 hover:bg-emerald-500'}">
              ${isWait ? 'ğŸ’° çµå¸³' : 'ğŸšš é€é¤'}
             </button>
          </div>
          <div class="space-y-1 mb-4 border-t border-white/10 pt-4">
            ${t.items.map(i => `<div class="text-sm text-gray-300 flex justify-between"><span>${i.item} x ${i.qty}</span><span class="text-cyan-300 font-bold">$${i.subtotal}</span></div>`).join('')}
          </div>
          <div class="text-right text-xl font-bold text-cyan-400 border-t border-white/10 pt-2">$${t.total}</div>
        </div>`;
      }).join('');
    }
  }

  async function handleTableStatus(tableNo){
    const next = tableButtonState[tableNo];
    if(next === 'completed' && !confirm('ç¢ºå®šçµå¸³ï¼Ÿ')) return;
    const res = await api({ action: "markTableStatus", table: tableNo, status: next });
    if(res.ok) {
      if(next === 'completed') delete tableButtonState[tableNo];
      else tableButtonState[tableNo] = 'completed';
      loadData();
    }
  }
</script>
</body>
</html>
