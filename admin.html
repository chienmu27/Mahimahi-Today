<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¥½æ¼æ—¥ï½œæ·±æµ·è—ç®¡ç†ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{font-family:'Noto Sans TC',sans-serif;background:#041c32;color:#e8f6ff;min-height:100vh;}
.nav-btn{padding:6px 14px;border-radius:8px;color:#a9d6e5;transition:all .3s}
.nav-btn.active{background:linear-gradient(135deg,#0077b6,#00b4d8);color:white;font-weight:bold}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:50}
.modal{background:rgba(255,255,255,0.05);backdrop-filter:blur(12px);padding:20px;border-radius:16px;min-width:300px;color:#e8f6ff;}
.card-served{background:rgba(0,119,182,0.2);border:2px solid #00b4d8;}
.card-normal{background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.1);}
table th{background:rgba(0,119,182,0.3);color:#90e0ef;text-transform:uppercase;font-size:.85rem;}
table td{border-bottom:1px solid rgba(255,255,255,.05);}
table tr:hover{background-color:rgba(255,255,255,.05);}
input{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2);color:white;border-radius:8px;}
input:focus{border-color:#00b4d8;outline:none;}
</style>
</head>
<body>

<script>
const GAS_API_URL="https://script.google.com/macros/s/AKfycbzRPw--Hr3zzmySCk5vZH4Ksc94oYmvapia87vUhvloDb0jE2OB-Qhvp5vCPHvV9A2P/exec";
let PASSWORD="";
let editRow=null;
let refreshTimer=null;
let processingTables={};

// API å‘¼å«
async function api(payload){
  payload.password=PASSWORD;
  const res=await fetch(GAS_API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain"},
    body:JSON.stringify(payload)
  });
  return await res.json();
}

// ç™»å…¥
async function login(){
  PASSWORD = document.getElementById("pwd").value.trim();
  if(!PASSWORD){document.getElementById("msg").innerText="è«‹è¼¸å…¥å¯†ç¢¼";return;}
  try{
    const res=await api({action:"adminLogin"});
    if(res.ok){
      document.getElementById("login").classList.add("hidden");
      document.getElementById("admin").classList.remove("hidden");
      startAutoRefresh();
      loadOrderCards();
    }else{
      document.getElementById("msg").innerText="å¯†ç¢¼éŒ¯èª¤";
    }
  }catch(e){
    document.getElementById("msg").innerText="é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¢ºèªç¶²è·¯";
    console.error(e);
  }
}

// åˆ†é 
function switchTab(tab){
  ["orders","history","menu"].forEach(t=>{
    document.getElementById(t).classList.add("hidden");
    document.getElementById("btn-"+t).classList.remove("active");
  });
  document.getElementById(tab).classList.remove("hidden");
  document.getElementById("btn-"+tab).classList.add("active");
  if(tab==="orders"){startAutoRefresh();loadOrderCards();}
  else{stopAutoRefresh();}
  if(tab==="history") loadOrders();
  if(tab==="menu") loadMenu();
}

// è‡ªå‹•åˆ·æ–°
function startAutoRefresh(){stopAutoRefresh();refreshTimer=setInterval(loadOrderCards,10000);}
function stopAutoRefresh(){if(refreshTimer) clearInterval(refreshTimer);}

// è¨‚å–®ç®¡ç†
async function loadOrderCards(){
  const res=await api({action:"getOrderHistory"});
  if(!res.ok) return;
  const grouped={};
  res.data.forEach(r=>{
    if(r.status==="completed") return;
    if(!grouped[r.table]) grouped[r.table]={items:[],status:r.status};
    grouped[r.table].items.push(r);
  });
  const tables=Object.keys(grouped).sort((a,b)=>Number(a)-Number(b));
  const root=document.getElementById("orderCards");
  root.innerHTML="";
  tables.forEach(table=>{
    const data=grouped[table];
    const total=data.items.reduce((s,i)=>s+Number(i.subtotal),0);
    const isServed=data.status==="served";
    const btnText=isServed?"ğŸ’° çµå¸³":"ğŸšš é€é¤";
    const newStatus=isServed?"completed":"served";
    const cardClass=isServed?"card-served":"card-normal";
    root.innerHTML+=`
    <div class="${cardClass} p-4 rounded shadow">
      <div class="flex justify-between mb-2">
        <h3 class="font-bold text-lg">æ¡Œè™Ÿ ${table}</h3>
        <button id="btn-${table}" onclick="handleStatus('${table}','${newStatus}',${total})" class="bg-${isServed?'blue':'green'}-600 text-white px-3 py-1 rounded">${btnText}</button>
      </div>
      ${data.items.map(i=>`<div class="flex justify-between text-sm"><span>${i.name} x ${i.qty}</span><span>$${i.subtotal}</span></div>`).join("")}
      <div class="text-right font-bold text-red-600 mt-2">ç¸½è¨ˆ $${total}</div>
    </div>`;
  });
}

// ç‹€æ…‹è™•ç†
async function handleStatus(table,newStatus,total){
  if(processingTables[table]) return;
  processingTables[table]=true;
  if(newStatus==="completed"){
    if(!confirm(`ç¢ºå®šçµå¸³ï¼Ÿ\næ¡Œè™Ÿ ${table}\né‡‘é¡ $${total}`)){
      processingTables[table]=false;
      return;
    }
  }
  document.getElementById("btn-"+table).disabled=true;
  const res=await api({action:"getOrderHistory"});
  const rows=res.data.filter(r=>r.table==table && r.status!=="completed");
  for(const r of rows){
    if(newStatus==="served" && r.status==="completed") continue;
    await api({action:"editOrderStatus",row:r.row,status:newStatus});
  }
  processingTables[table]=false;
  loadOrderCards();
  loadOrders();
}

// è¨‚å–®ç¸½è¡¨
async function loadOrders(){
  const res=await api({action:"getOrderHistory"});
  if(!res.ok)return;
  document.getElementById("orderBody").innerHTML=res.data.map(r=>`
<tr>
<td>${new Date(r.time).toLocaleString()}</td>
<td>${r.name}</td>
<td>${r.price}</td>
<td>${r.qty}</td>
<td>${r.subtotal}</td>
<td>${r.table}</td>
<td>${r.status}</td>
<td><button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteOrder(${r.row})">åˆªé™¤</button></td>
</tr>`).join("");
}

// å–®ç­†åˆªé™¤
async function deleteOrder(row){if(!confirm("ç¢ºå®šåˆªé™¤?")) return; await api({action:"deleteOrder",row}); loadOrders();}

// å…¨éƒ¨åˆªé™¤
async function clearAllOrders(){if(!confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨‚å–®è³‡æ–™ï¼Ÿ")) return; await api({action:"clearAllOrders"}); loadOrders(); loadOrderCards();}

// èœå–®ç®¡ç†
async function loadMenu(){
  const res=await api({action:"getMenu"});
  if(!res.ok) return;
  document.getElementById("menuBody").innerHTML=res.data.map(m=>`
<tr>
<td>${m.category}</td>
<td>${m.name}</td>
<td>${m.desc}</td>
<td>${m.price}</td>
<td>
<button onclick="showEditModal(${m.row},'${m.category}','${m.name}','${m.desc}',${m.price})" class="bg-yellow-500 text-white px-2 py-1 rounded">ç·¨è¼¯</button>
<button onclick="deleteMenu(${m.row})" class="bg-red-500 text-white px-2 py-1 rounded">åˆªé™¤</button>
</td>
</tr>`).join("");
}
function addMenu(){showEditModal(null,"","","",0);}
function showEditModal(row,c,n,d,p){editRow=row;modalCategory.value=c;modalName.value=n;modalDesc.value=d;modalPrice.value=p;editModal.classList.remove("hidden");}
async function confirmEdit(){
  if(editRow) await api({action:"editMenuItem",row:editRow,category:modalCategory.value,name:modalName.value,desc:modalDesc.value,price:modalPrice.value});
  else await api({action:"addMenuItem",category:modalCategory.value,name:modalName.value,desc:modalDesc.value,price:modalPrice.value});
  cancelEdit(); loadMenu();
}
function cancelEdit(){editModal.classList.add("hidden");}
async function deleteMenu(row){if(!confirm("ç¢ºå®šåˆªé™¤?"))return; await api({action:"deleteMenuItem",row}); loadMenu();}
</script>

<!-- ç™»å…¥ç•«é¢ -->
<div id="login" class="fixed inset-0 flex items-center justify-center bg-blue-900">
  <div class="bg-glass-card p-8 rounded-2xl w-80">
    <h2 class="text-xl font-bold text-center mb-4">ç®¡ç†ç™»å…¥</h2>
    <input id="pwd" type="password" class="w-full border p-2 mb-4 rounded" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeypress="if(event.key==='Enter'){login();}">
    <button onclick="login()" class="w-full bg-gradient-to-r from-blue-700 to-sky-500 text-white p-2 rounded">ç™»å…¥</button>
    <div id="msg" class="text-red-500 text-center mt-2"></div>
  </div>
</div>

<!-- ç®¡ç†é  -->
<div id="admin" class="hidden">
<header class="bg-gradient-to-r from-blue-800 to-sky-700 text-white p-4 flex justify-between glass-card shadow-lg">
<h1 class="text-lg font-bold">å¥½æ¼æ—¥ï½œæ·±æµ·è—ç®¡ç†ç³»çµ±</h1>
<div class="flex gap-2">
<button id="btn-orders" onclick="switchTab('orders')" class="nav-btn active">è¨‚å–®ç®¡ç†</button>
<button id="btn-history" onclick="switchTab('history')" class="nav-btn">è¨‚å–®ç¸½è¡¨</button>
<button id="btn-menu" onclick="switchTab('menu')" class="nav-btn">èœå–®ç®¡ç†</button>
</div>
</header>

<div class="p-6">
<section id="orders">
<div class="flex justify-between mb-4">
<h2 class="font-bold text-lg">å³æ™‚è¨‚å–®</h2>
<button onclick="loadOrderCards()" class="bg-gradient-to-r from-blue-700 to-sky-500 px-3 py-1 rounded">æ‰‹å‹•åˆ·æ–°</button>
</div>
<div id="orderCards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</section>

<section id="history" class="hidden">
<div class="flex justify-end mb-2">
<button onclick="clearAllOrders()" class="bg-red-600 text-white px-3 py-1 rounded">å…¨éƒ¨åˆªé™¤</button>
</div>
<table class="w-full glass-card shadow rounded">
<thead>
<tr>
<th>æ—¥æœŸæ™‚é–“</th>
<th>å“é …</th>
<th>å–®åƒ¹</th>
<th>æ•¸é‡</th>
<th>å°è¨ˆ</th>
<th>æ¡Œè™Ÿ</th>
<th>ç‹€æ…‹</th>
<th>æ“ä½œ</th>
</tr>
</thead>
<tbody id="orderBody"></tbody>
</table>
</section>

<section id="menu" class="hidden">
<button onclick="addMenu()" class="mb-3 bg-green-600 text-white px-3 py-1 rounded">æ–°å¢</button>
<table class="w-full glass-card shadow rounded">
<thead>
<tr><th>åˆ†é¡</th><th>åç¨±</th><th>æè¿°</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr>
</thead>
<tbody id="menuBody"></tbody>
</table>
</section>
</div>
</div>

<div id="editModal" class="modal-bg hidden">
<div class="modal">
<h3 class="text-lg font-bold mb-2">ç·¨è¼¯èœå–®</h3>
<table class="w-full mb-3">
<tr><td>åˆ†é¡</td><td><input id="modalCategory" class="border p-1 w-full"></td></tr>
<tr><td>åç¨±</td><td><input id="modalName" class="border p-1 w-full"></td></tr>
<tr><td>æè¿°</td><td><input id="modalDesc" class="border p-1 w-full"></td></tr>
<tr><td>åƒ¹æ ¼</td><td><input id="modalPrice" type="number" class="border p-1 w-full"></td></tr>
</table>
<div class="flex justify-end gap-2">
<button onclick="confirmEdit()" class="bg-green-600 text-white px-3 py-1 rounded">ç¢ºèª</button>
<button onclick="cancelEdit()" class="bg-gray-400 text-white px-3 py-1 rounded">å–æ¶ˆ</button>
</div>
</div>
</div>

</body>
</html>
